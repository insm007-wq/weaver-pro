import { useCallback, useMemo, useState, useEffect, Suspense, lazy, memo } from "react";
import { makeStyles, shorthands, tokens, Card, CardHeader, Body1, Title1, Title2, Subtitle1, Text, mergeClasses, Button } from "@fluentui/react-components";
import KeepAlivePane from "./components/common/KeepAlivePane";
import { LoadingSpinner, GlobalToast } from "./components/common";
import { useFontOverrideStyles } from "./styles/commonStyles";

const Sidebar = lazy(() => import("./components/Sidebar"));
const ProjectInit = lazy(() => import("./components/ProjectInit"));
const SettingsPage = lazy(() => import("./components/SettingsPage"));
const ProjectManager = lazy(() => import("./components/ProjectManager"));
const HeaderBar = lazy(() => import("./components/HeaderBar"));
const ThumbnailGenerator = lazy(() => import("./components/ThumbnailGenerator/ThumbnailGenerator"));
const ScriptVoiceGenerator = lazy(() => import("./components/scriptgen/ScriptVoiceGenerator"));
const MediaPrepEditor = lazy(() => import("./components/media-prep/MediaPrepEditor"));
const MediaDownloadPage = lazy(() => import("./components/media-down/MediaDownloadPage"));
const MediaEditPage = lazy(() => import("./components/media-edit/MediaEditPage"));
const TermsOfService = lazy(() => import("./components/TermsOfService"));

const useStyles = makeStyles({
  root: {
    display: "flex",
    minHeight: "100vh",
    flexDirection: "column",
    backgroundColor: tokens.colorNeutralBackground1,
  },
  header: {
    backgroundColor: tokens.colorNeutralBackground2,
    ...shorthands.borderBottom("1px", "solid", tokens.colorNeutralStroke1),
  },
  body: {
    display: "flex",
    flex: 1,
    overflow: "hidden",
  },
  main: {
    flex: 1,
    ...shorthands.padding(tokens.spacingVerticalXXL, tokens.spacingHorizontalXXL),
    overflowY: "auto",
    backgroundColor: tokens.colorNeutralBackground1,
  },
  loadingContainer: {
    display: "flex",
    alignItems: "center",
    justifyContent: "center",
    ...shorthands.padding(tokens.spacingVerticalXXXL),
    ...shorthands.gap(tokens.spacingHorizontalM),
  },
  welcomeCard: {
    maxWidth: "800px",
    ...shorthands.margin("0", "auto"),
    animation: "fadeIn 0.3s ease-out",
  },
  welcomeHeader: {
    display: "flex",
    alignItems: "center",
    ...shorthands.gap(tokens.spacingHorizontalL),
  },
  logoBox: {
    width: "48px",
    height: "48px",
    backgroundImage: `linear-gradient(135deg, ${tokens.colorBrandBackground}, ${tokens.colorBrandBackground2})`,
    ...shorthands.borderRadius(tokens.borderRadiusLarge),
    display: "flex",
    alignItems: "center",
    justifyContent: "center",
    color: tokens.colorNeutralForegroundOnBrand,
    fontSize: tokens.fontSizeBase600,
    boxShadow: tokens.shadow16,
  },
  gridContainer: {
    display: "grid",
    gridTemplateColumns: "repeat(auto-fit, minmax(250px, 1fr))",
    ...shorthands.gap(tokens.spacingHorizontalL),
    marginTop: tokens.spacingVerticalL,
  },
  featureCard: {
    ...shorthands.padding(tokens.spacingVerticalL, tokens.spacingHorizontalL),
    ...shorthands.borderRadius(tokens.borderRadiusMedium),
    ...shorthands.border("1px", "solid", tokens.colorNeutralStroke2),
  },
  quickStartCard: {
    backgroundColor: tokens.colorBrandBackground2,
    ...shorthands.borderColor(tokens.colorBrandStroke1),
  },
  newFeatureCard: {
    backgroundColor: tokens.colorPaletteGreenBackground2,
    ...shorthands.borderColor(tokens.colorPaletteGreenBorder2),
  },
});

const MemoizedLoadingFallback = memo(function LoadingFallback({ label = "Î°úÎî© Ï§ë..." }) {
  const styles = useStyles();
  return (
    <LoadingSpinner size="medium" message={label} centered />
  );
});

function App() {
  const [projectName, setProjectName] = useState(null);
  const [currentPage, setCurrentPage] = useState(null);
  const [isScriptGenerating, setIsScriptGenerating] = useState(false);
  const [isVideoExporting, setIsVideoExporting] = useState(false);
  const [isMediaDownloading, setIsMediaDownloading] = useState(false);
  const [termsAccepted, setTermsAccepted] = useState(null); // null: Î°úÎî© Ï§ë, false: ÎØ∏ÎèôÏùò, true: ÎèôÏùò
  const [hasProject, setHasProject] = useState(true); // ÌîÑÎ°úÏ†ùÌä∏ Ï°¥Ïû¨ Ïó¨Î∂Ä
  const canOpenWithoutProject = true;
  const styles = useStyles();
  const fontStyles = useFontOverrideStyles();

  // ÏïΩÍ¥Ä ÎèôÏùò Ïó¨Î∂Ä ÌôïÏù∏
  useEffect(() => {
    const checkTermsAcceptance = async () => {
      try {
        console.log("üîç [App.jsx] ÏïΩÍ¥Ä ÎèôÏùò Ïó¨Î∂Ä ÌôïÏù∏ Ï§ë...");
        console.log("üîç [App.jsx] window.electron:", window.electron);
        console.log("üîç [App.jsx] window.electron.store:", window.electron?.store);
        const accepted = await window.electron?.store?.getTermsAccepted();
        console.log("üîç [App.jsx] ÏïΩÍ¥Ä ÎèôÏùò ÏÉÅÌÉú:", accepted);
        setTermsAccepted(accepted || false);
      } catch (error) {
        console.error("‚ùå [App.jsx] ÏïΩÍ¥Ä ÎèôÏùò Ïó¨Î∂Ä ÌôïÏù∏ Ïã§Ìå®:", error);
        setTermsAccepted(false);
      }
    };
    checkTermsAcceptance();
  }, []);

  // ÌîÑÎ°úÏ†ùÌä∏ Ï°¥Ïû¨ Ïó¨Î∂Ä ÌôïÏù∏
  useEffect(() => {
    const checkProjectExists = async () => {
      try {
        const result = await window.api?.invoke?.("project:list");
        if (result?.success) {
          const projects = Array.isArray(result.data?.projects)
            ? result.data.projects
            : Array.isArray(result.projects)
            ? result.projects
            : [];
          // ÌîÑÎ°úÏ†ùÌä∏Í∞Ä 1Í∞ú Ïù¥ÏÉÅ Ï°¥Ïû¨ÌïòÎ©¥ true
          setHasProject(projects.length > 0);
          console.log("üìä [App.jsx] ÌîÑÎ°úÏ†ùÌä∏ Ï°¥Ïû¨ Ïó¨Î∂Ä:", projects.length > 0, `(${projects.length}Í∞ú)`);
        } else {
          setHasProject(false);
        }
      } catch (error) {
        console.error("‚ùå [App.jsx] ÌîÑÎ°úÏ†ùÌä∏ Î™©Î°ù ÌôïÏù∏ Ïã§Ìå®:", error);
        setHasProject(false);
      }
    };

    checkProjectExists();
  }, []);

  // ÌîÑÎ°úÏ†ùÌä∏ ÏÉùÏÑ± ÏôÑÎ£å Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà
  useEffect(() => {
    const handleProjectCreated = () => {
      console.log("‚úÖ [App.jsx] ÌîÑÎ°úÏ†ùÌä∏ ÏÉùÏÑ±Îê® - ÌÉ≠ ÌôúÏÑ±Ìôî");
      setHasProject(true);
    };

    window.addEventListener("project:created", handleProjectCreated);
    return () => window.removeEventListener("project:created", handleProjectCreated);
  }, []);

  // ÌîÑÎ°úÏ†ùÌä∏ ÏÇ≠Ï†ú ÏôÑÎ£å Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà
  useEffect(() => {
    const handleProjectDeleted = async () => {
      console.log("üóëÔ∏è [App.jsx] ÌîÑÎ°úÏ†ùÌä∏ ÏÇ≠Ï†úÎê® - hasProject ÏÉÅÌÉú Í∞±Ïã†");
      try {
        const result = await window.api?.invoke?.("project:list");
        if (result?.success) {
          const projects = Array.isArray(result.data?.projects)
            ? result.data.projects
            : Array.isArray(result.projects)
            ? result.projects
            : [];
          setHasProject(projects.length > 0);
          console.log("üìä [App.jsx] ÌîÑÎ°úÏ†ùÌä∏ Ï°¥Ïû¨ Ïó¨Î∂Ä Í∞±Ïã†:", projects.length > 0, `(${projects.length}Í∞ú)`);
        }
      } catch (error) {
        console.error("‚ùå [App.jsx] ÌîÑÎ°úÏ†ùÌä∏ ÏÉÅÌÉú Í∞±Ïã† Ïã§Ìå®:", error);
        setHasProject(false);
      }
    };

    window.addEventListener("project:deleted", handleProjectDeleted);
    return () => window.removeEventListener("project:deleted", handleProjectDeleted);
  }, []);

  const handleAcceptTerms = async () => {
    try {
      console.log("üíæ [App.jsx] ÏïΩÍ¥Ä ÎèôÏùò Ï†ÄÏû• ÏãúÎèÑ...");
      const result = await window.electron?.store?.setTermsAccepted(true);
      console.log("üíæ [App.jsx] ÏïΩÍ¥Ä ÎèôÏùò Ï†ÄÏû• Í≤∞Í≥º:", result);
      setTermsAccepted(true);
    } catch (error) {
      console.error("‚ùå [App.jsx] ÏïΩÍ¥Ä ÎèôÏùò Ï†ÄÏû• Ïã§Ìå®:", error);
    }
  };

  // ÎîîÎ≤ÑÍπÖ: ÏÉÅÌÉú Î≥ÄÍ≤Ω ÌôïÏù∏
  useEffect(() => {
    console.log("üî¥ App.jsx - isScriptGenerating:", isScriptGenerating);
  }, [isScriptGenerating]);

  const handleCreateProject = useCallback((name) => {
    setProjectName(name);
    setCurrentPage("script");
  }, []);
  
  const handleSelectMenu = useCallback((key) => setCurrentPage(key), []);
  const handleOpenSettings = useCallback(() => setCurrentPage("settings"), []);

  // Î©îÎ™®Ïù¥Ï†úÏù¥ÏÖòÎêú Í≥ÑÏÇ∞Í∞íÎì§
  const shouldShowProjectInit = useMemo(() => 
    !projectName && !canOpenWithoutProject, 
    [projectName, canOpenWithoutProject]
  );

  const isHomePage = useMemo(() => currentPage === null, [currentPage]);

  useEffect(() => {
    if (!window.__autoPlaceQueue) window.__autoPlaceQueue = [];
    const off = window.api?.onFileDownloaded?.((payload) => {
      try {
        if (payload?.path) window.__autoPlaceQueue.push(payload);
      } catch {}
    });
    return () => {
      try {
        off && off();
      } catch {}
    };
  }, []);

  // ÎØ∏ÎîîÏñ¥ Îã§Ïö¥Î°úÎìú ÌéòÏù¥ÏßÄÎ°ú Ïù¥ÎèôÌïòÎäî Ïª§Ïä§ÌÖÄ Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà
  useEffect(() => {
    const handleNavigateToDownload = () => {
      setCurrentPage('draft');
    };

    window.addEventListener('navigate-to-download', handleNavigateToDownload);

    return () => {
      window.removeEventListener('navigate-to-download', handleNavigateToDownload);
    };
  }, []);

  // ÏòÅÏÉÅ ÏôÑÏÑ± ÌéòÏù¥ÏßÄÎ°ú Ïù¥ÎèôÌïòÎäî Ïª§Ïä§ÌÖÄ Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà
  useEffect(() => {
    const handleNavigateToRefine = () => {
      setCurrentPage('refine');
    };

    window.addEventListener('navigate-to-refine', handleNavigateToRefine);

    return () => {
      window.removeEventListener('navigate-to-refine', handleNavigateToRefine);
    };
  }, []);

  // ÎØ∏ÎîîÏñ¥ Ï§ÄÎπÑ ÌéòÏù¥ÏßÄÎ°ú Ïù¥ÎèôÌïòÎäî Ïª§Ïä§ÌÖÄ Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà
  useEffect(() => {
    const handleNavigateToAssemble = () => {
      setCurrentPage('assemble');
    };

    window.addEventListener('navigate-to-assemble', handleNavigateToAssemble);

    return () => {
      window.removeEventListener('navigate-to-assemble', handleNavigateToAssemble);
    };
  }, []);

  // ÎØ∏ÎîîÏñ¥ Îã§Ïö¥Î°úÎìú ÌéòÏù¥ÏßÄÎ°ú Ïù¥ÎèôÌïòÎäî Ïª§Ïä§ÌÖÄ Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà
  useEffect(() => {
    const handleNavigateToDownload = () => {
      setCurrentPage('draft');
    };

    window.addEventListener('navigate-to-download', handleNavigateToDownload);

    return () => {
      window.removeEventListener('navigate-to-download', handleNavigateToDownload);
    };
  }, []);

  // ÏïΩÍ¥Ä ÎèôÏùò Ïó¨Î∂Ä Î°úÎî© Ï§ë
  if (termsAccepted === null) {
    return <MemoizedLoadingFallback label="Ï¥àÍ∏∞Ìôî Ï§ë..." />;
  }

  // ÏïΩÍ¥Ä ÎØ∏ÎèôÏùò Ïãú ÏïΩÍ¥Ä ÌôîÎ©¥ ÌëúÏãú
  if (!termsAccepted) {
    return (
      <Suspense fallback={<MemoizedLoadingFallback label="ÏïΩÍ¥Ä Î°úÎî© Ï§ë..." />}>
        <TermsOfService onAccept={handleAcceptTerms} />
      </Suspense>
    );
  }

  return (
    <div className={mergeClasses(styles.root, fontStyles.globalFont)}>
      <Suspense fallback={<MemoizedLoadingFallback label="Ìó§Îçî Î°úÎî© Ï§ë..." />}>
        <div className={styles.header}>
          <HeaderBar onOpenSettings={handleOpenSettings} />
        </div>
      </Suspense>

      <div className={styles.body}>
        <Suspense fallback={<MemoizedLoadingFallback />}>
          <Sidebar
            onSelectMenu={handleSelectMenu}
            isScriptGenerating={isScriptGenerating}
            isVideoExporting={isVideoExporting}
            isMediaDownloading={isMediaDownloading}
            hasProject={hasProject}
          />
        </Suspense>

        <main className={styles.main}>
          <Suspense fallback={<MemoizedLoadingFallback />}>
            {shouldShowProjectInit ? (
              <ProjectInit onCreate={handleCreateProject} />
            ) : (
              <>
                <KeepAlivePane active={isHomePage}>
                  <Card className={styles.welcomeCard}>
                    <CardHeader
                      header={
                        <div className={styles.welcomeHeader}>
                          <div className={styles.logoBox}>üé•</div>
                          <div>
                            <Title2>{projectName || "Weaver Pro"}</Title2>
                            <Subtitle1>AI Í∏∞Î∞ò ÏòÅÏÉÅ Ï†úÏûë ÏÜîÎ£®ÏÖòÏóê Ïò§Ïã† Í≤ÉÏùÑ ÌôòÏòÅÌï©ÎãàÎã§</Subtitle1>
                          </div>
                        </div>
                      }
                    />

                    <div className={styles.gridContainer}>
                      <div className={mergeClasses(styles.featureCard, styles.quickStartCard)}>
                        <Text as="h3" weight="semibold" size={500}>
                          üéØ Îπ†Î•∏ ÏãúÏûë
                        </Text>
                        <Body1>ÏôºÏ™Ω ÏÇ¨Ïù¥ÎìúÎ∞îÏóêÏÑú ÏõêÌïòÎäî Í∏∞Îä•ÏùÑ ÏÑ†ÌÉùÌïòÏó¨ ÏãúÏûëÌïòÏÑ∏Ïöî.</Body1>
                      </div>

                      <div className={mergeClasses(styles.featureCard, styles.newFeatureCard)}>
                        <Text as="h3" weight="semibold" size={500}>
                          ‚ö° ÏÉàÎ°úÏö¥ Í∏∞Îä•
                        </Text>
                        <Body1>ÏµúÏã† AI Î™®Îç∏Í≥º Ìñ•ÏÉÅÎêú ÏÇ¨Ïö©Ïûê Í≤ΩÌóòÏùÑ Ï≤¥ÌóòÌï¥Î≥¥ÏÑ∏Ïöî.</Body1>
                      </div>
                    </div>
                  </Card>
                </KeepAlivePane>

                <KeepAlivePane active={currentPage === "thumbnail"}>
                  <ThumbnailGenerator />
                </KeepAlivePane>

                <KeepAlivePane active={currentPage === "script"}>
                  <ScriptVoiceGenerator onGeneratingChange={setIsScriptGenerating} />
                </KeepAlivePane>

                <KeepAlivePane active={currentPage === "assemble"}>
                  <MediaPrepEditor />
                </KeepAlivePane>

                <KeepAlivePane active={currentPage === "draft"}>
                  <MediaDownloadPage onDownloadingChange={setIsMediaDownloading} />
                </KeepAlivePane>

                <KeepAlivePane active={currentPage === "refine"}>
                  <MediaEditPage
                    isVideoExporting={isVideoExporting}
                    setIsVideoExporting={setIsVideoExporting}
                  />
                </KeepAlivePane>


                <KeepAlivePane active={currentPage === "settings"}>
                  <SettingsPage onBack={() => setCurrentPage(null)} />
                </KeepAlivePane>

                <KeepAlivePane active={currentPage === "projects"}>
                  <ProjectManager />
                </KeepAlivePane>
              </>
            )}
          </Suspense>
        </main>
      </div>

      {/* ÌîÑÎ°úÏ†ùÌä∏ ÏóÜÏùÑ Îïå ÌïòÎã® Í≥†Ï†ïÎ∞î */}
      {!hasProject && (
        <div
          style={{
            position: "fixed",
            bottom: 0,
            left: 0,
            right: 0,
            zIndex: 999,
            background: tokens.colorNeutralBackground1,
            borderTop: `2px solid ${tokens.colorPaletteBlueBackground3}`,
            boxShadow: "0 -4px 12px rgba(0,0,0,0.1)",
            transition: "all 0.3s ease",
            animation: "slideInUp 0.4s cubic-bezier(0.4, 0, 0.2, 1) both",
          }}
        >
          {/* Í≥†Ï†ïÎ∞î ÏΩòÌÖêÏ∏† */}
          <div
            style={{
              padding: `${tokens.spacingVerticalL} ${tokens.spacingHorizontalXXL}`,
              display: "flex",
              alignItems: "center",
              justifyContent: "space-between",
              gap: tokens.spacingHorizontalL,
              cursor: "pointer",
            }}
          >
            {/* ÏôºÏ™Ω: ÏÉÅÌÉú Ï†ïÎ≥¥ */}
            <div style={{ display: "flex", alignItems: "center", gap: tokens.spacingHorizontalM, flex: 1 }}>
              {/* ÏÉÅÌÉú ÏïÑÏù¥ÏΩò */}
              <div
                style={{
                  width: 10,
                  height: 10,
                  borderRadius: "50%",
                  background: tokens.colorPaletteBlueBackground3,
                  animation: "pulse 2s infinite",
                }}
              />
              {/* ÏÉÅÌÉú ÌÖçÏä§Ìä∏ (ÍπúÎπ°ÏûÑ Ïï†ÎãàÎ©îÏù¥ÏÖò) */}
              <Text
                size={300}
                weight="semibold"
                style={{
                  animation: "textBlink 2s ease-in-out infinite"
                }}
              >
                üìÅ Î®ºÏ†Ä ÌîÑÎ°úÏ†ùÌä∏Î•º ÏÉùÏÑ±Ìï¥Ï£ºÏÑ∏Ïöî!
              </Text>
            </div>

            {/* Ïò§Î•∏Ï™Ω: Ïï°ÏÖò Î≤ÑÌäº */}
            <Button
              appearance="primary"
              onClick={() => setCurrentPage("projects")}
              style={{
                background: "linear-gradient(135deg, #667eea 0%, #764ba2 100%)",
                borderRadius: 8,
                fontSize: "13px",
                fontWeight: 600,
                border: "none",
                minWidth: "180px",
              }}
            >
              ÌîÑÎ°úÏ†ùÌä∏ ÏÉùÏÑ±ÌïòÎü¨ Í∞ÄÍ∏∞ ‚Üí
            </Button>
          </div>
        </div>
      )}

      {/* Ï†ÑÏó≠ ÌÜ†Ïä§Ìä∏ */}
      <GlobalToast />

      {/* Ïï†ÎãàÎ©îÏù¥ÏÖò Ïä§ÌÉÄÏùº */}
      <style>{`
        @keyframes pulse {
          0%, 100% { opacity: 1; transform: scale(1); }
          50% { opacity: 0.7; transform: scale(1.2); }
        }
        @keyframes textBlink {
          0%, 100% { opacity: 1; }
          50% { opacity: 0.3; }
        }
        @keyframes slideInUp {
          from {
            opacity: 0;
            transform: translateY(100%);
          }
          to {
            opacity: 1;
            transform: translateY(0);
          }
        }
      `}</style>
    </div>
  );
}

export default memo(App);
